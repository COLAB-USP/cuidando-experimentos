<!DOCTYPE html>
<html>
<head>
	<title>Leaflet Layers Control Example</title>
	<meta charset="utf-8" />

	<meta name="viewport" content="width=device-width, initial-scale=1.0">

	<link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.css" />
	<!--[if lte IE 8]><link rel="stylesheet" href="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.ie.css" /><![endif]-->
	<script src="http://cdn.leafletjs.com/leaflet-0.6.4/leaflet.js"></script>
	<script src="jquery-1.10.2.min.js"></script>
	<script src="jquery.csv-0.71.min.js"></script>
	<link rel="stylesheet" href="MarkerCluster.css" />
	<link rel="stylesheet" href="MarkerCluster.Default.css" />
	<script src="leaflet.markercluster-src.js"></script>
	<!--[if lte IE 8]><link rel="stylesheet" href="../dist/leaflet.ie.css" /><![endif]-->
	<script src="KML.js"></script>  


</head>
<body>
	<div id="map" style="width: 1024px; height: 768px"></div>

	<script>
	
		
		$.get("creches3.csv", function(data){ // Função em JQUERY para acessar um arquivo no servidor.
			var teste = $.csv.toArrays(data); // Função da biblioteca para converter o csv em um array.


			// Criando ícones customizados
			var redIcon = L.Icon.Default.extend({
				options: {
					iconUrl: 'img/carrinho-azul.png',
					iconSize:     [50, 41],
					popupAnchor:  [15, -41],
				}
			});
			var greenIcon = L.Icon.Default.extend({
				options: {
					iconUrl: 'img/carrinho-verde.png', 
					iconSize:     [50, 41],
					popupAnchor:  [15, -41],
				}
			});
			var orangeIcon = L.Icon.Default.extend({
				options: {
					iconUrl: 'img/carrinho-laranja.png',
					iconSize:     [50, 41],
					popupAnchor:  [15, -41],
				}
			});
			var redIcon = new redIcon();
			var greenIcon = new greenIcon();
			var orangeIcon = new orangeIcon();

			//var publica = new L.LayerGroup(); // Criando LayerGroup para creches publicas
			//var privada = new L.LayerGroup(); // Criando LayerGroup para creches particulares
			// Criando Layers
			var publica = L.markerClusterGroup();
			var privada = L.markerClusterGroup();

			// Percorrendo o array que contém os dados do CSV
			for(var i=1; i<teste.length-1; i++){
				var a = teste[i];
				if(a[1] == 'PUBLICA' || a[1] == 'Publica' || a[1][2] == 'b'){ // Filtro para separar as creches
					console.log("S",a[1]);
					var marker = L.marker([a[4],a[3]],{icon: redIcon}).bindPopup(a[0]+"<br>"+"Distrito: "+a[2]).addTo(publica); // Jogando no mapa
				}else{
					console.log("N",a[1], a[1][2]);
					var marker = L.marker([a[4],a[3]],{icon: greenIcon}).bindPopup(a[0]+"<br>"+"Distrito: "+a[2]).addTo(privada); // Jogando no mapa
				}
			}
			var cmAttr = 'Map data &copy; 2011 OpenStreetMap contributors, Imagery &copy; 2011 CloudMade',
				cmUrl = 'http://{s}.tile.cloudmade.com/BC9A493B41014CAABB98F0471D759707/{styleId}/256/{z}/{x}/{y}.png';

			var minimal   = L.tileLayer(cmUrl, {styleId: 22677, attribution: cmAttr});

			// Criando o mapa
			var map = L.map('map', {
				center: [-23.5335074, -46.5666354],
				zoom: 10,
				layers: [minimal, publica, privada] 
			});
		
			//Layer delimitacao	
			var distritos = new L.KML("distritos.kml", {async: true});
			map.addLayer(distritos);
			
			//Layers
			var baseLayers = {
				"Minimal": minimal,
			};
			//Overlays
			var overlays = {
				"Públicas": publica,
				"Privadas": privada,
				"Distritos": distritos
			};

			L.control.layers(baseLayers, overlays).addTo(map);
		});
        
	</script>
</body>
</html>
